# 전략 계획서: v01_adaptive_rsi_ml

**작성일**: 2025-10-16 18:39
**버전**: v01
**전략명**: Adaptive RSI + ML 기반 동적 임계값 최적화
**타입**: hybrid (rule_based + ml)

---

## 📊 이전 버전 분석 요약

### 이전 버전 성과
- **이전 버전 없음** (첫 번째 전략)

### 문제 인식
- 단순 고정 RSI 임계값(30/70)은 시장 변동성에 대응 불가
- 2024-2025년 연구에 따르면 정적 지표만으로는 수익 창출 어려움
- 시장 상황(변동성, 추세)에 따라 최적 임계값이 달라짐

---

## 🎯 새로운 가설 및 아이디어

### 핵심 가설
> **"Rolling Window로 최근 30개 캔들의 시장 상황을 분석하여 RSI/MACD 임계값을 실시간 조정하고, Random Forest로 거래 신호를 검증하면 고정 임계값 대비 20-30% 성과 향상 가능"**

### 이론적 근거
1. **Bufi's Adaptive Threshold (BAT)**: 시장 추세와 변동성에 따라 RSI 임계값을 동적 조정 (2024년 연구)
2. **Rolling Window LSTM**: 최근 데이터에 가중치를 두어 예측 정확도 향상
3. **Random Forest Ensemble**: 90%+ 정확도로 false signal 감소 (2024년 연구)
4. **DQN 강화학습**: 63.98% ROI 달성 사례 존재 (BinanceCoin, 2024)

### 차별화 포인트
- ❌ **기존**: 고정된 RSI 30/70 임계값
- ✅ **v01**: 시장 상황별 동적 임계값 (20-80 범위에서 조정)
- ✅ **ML 검증**: Random Forest로 70% 이상 확신 시에만 거래

---

## 🛠️ 구현 계획

### 1. 기술 지표 선택
```python
indicators = {
    "momentum": ["RSI"],           # RSI(14)
    "trend": ["MACD", "ADX"],      # MACD(12,26,9), ADX(14)
    "volatility": ["ATR"],         # ATR(14)
    "price": ["ROC"]               # Rate of Change
}
```

### 2. 시장 상태 분류기
```python
# 최근 30개 캔들 분석
def classify_market_regime(df, window=30):
    # 변동성 (ATR 기반)
    volatility = calculate_volatility(df[-window:])  # 높음/보통/낮음

    # 추세 강도 (ADX 기반)
    trend = calculate_trend_strength(df[-window:])   # 강/중/약

    # 가격 모멘텀 (선형회귀 기울기)
    momentum = calculate_momentum(df[-window:])      # 상승/횡보/하락

    return (volatility, trend, momentum)  # 9가지 상태
```

### 3. Adaptive RSI Threshold (BAT 구현)
```python
def calculate_adaptive_threshold(df, window=30, base_oversold=30, base_overbought=70):
    recent = df[-window:]

    # 추세 기울기 (선형회귀)
    slope = linear_regression_slope(recent['close'])

    # 변동성 (표준편차)
    volatility = recent['close'].std()

    # 임계값 조정
    if slope > 0.02 and volatility > threshold_high:
        # 강한 상승장 + 높은 변동성
        oversold = base_oversold + 10   # 40
        overbought = base_overbought + 10  # 80
    elif abs(slope) < 0.01 and volatility < threshold_low:
        # 횡보장 + 낮은 변동성
        oversold = base_oversold - 10  # 20
        overbought = base_overbought + 10  # 80
    else:
        # 기본값
        oversold = base_oversold
        overbought = base_overbought

    return oversold, overbought
```

### 4. Random Forest 신호 검증
```python
# 학습 데이터 생성
features = [
    'rsi', 'macd', 'macd_signal', 'macd_hist',
    'atr', 'adx', 'roc',
    'volume_ratio', 'price_momentum',
    'adaptive_oversold', 'adaptive_overbought',
    'market_regime_volatility', 'market_regime_trend', 'market_regime_momentum'
]

# Label: 다음 N개 캔들 후 수익 여부 (예: 5개 캔들 후 +2% 이상)
label = future_profit > 0.02

# Random Forest 학습 (최근 1000개 캔들)
rf_model = RandomForestClassifier(n_estimators=100, max_depth=10)
rf_model.fit(X_train, y_train)

# 거래 시점에 확률 예측
buy_probability = rf_model.predict_proba(current_features)[0][1]
if buy_probability > 0.7:  # 70% 이상 확신
    execute_buy()
```

### 5. 진입/청산 규칙

**매수 조건** (모두 만족):
1. 시장 상태 분류 (최근 30개 캔들)
2. RSI < adaptive_oversold (동적 임계값)
3. MACD 골든크로스 (macd > macd_signal, 직전 캔들은 반대)
4. Random Forest 확률 > 0.7
5. ADX > 20 (추세 강도 확인)

**매도 조건** (하나라도 만족):
1. RSI > adaptive_overbought (동적 임계값)
2. MACD 데드크로스
3. Random Forest 매도 확률 > 0.7

**익절/손절**:
- 익절: +5% 도달 시 50% 청산, +10% 도달 시 전량 청산
- 손절: -3% 도달 시 전량 청산

### 6. 포지션 사이징
- Kelly Criterion 적용 (kelly_fraction=0.25)
- 초기 50회 거래: 고정 30% 투자 (승률 확보)
- 50회 이후: Kelly * 0.25 비율로 투자

### 7. 타임프레임 전략
- **주 타임프레임**: minute5
- **참고 타임프레임**: 없음 (v01은 단일 타임프레임)
- **다중 타임프레임**: v02 이후 고려

---

## ⚙️ 하이퍼파라미터 초기값

```json
{
  "strategy_name": "adaptive_rsi_ml",
  "version": "v01",
  "timeframe": "minute5",

  "rolling_window": 30,
  "rsi_period": 14,

  "volatility_threshold": {
    "high": 0.03,
    "low": 0.01
  },

  "adaptive_rsi": {
    "base_oversold": 30,
    "base_overbought": 70,
    "adjustment_range": 20
  },

  "macd": {
    "fast": 12,
    "slow": 26,
    "signal": 9
  },

  "ml_model": {
    "type": "RandomForest",
    "n_estimators": 100,
    "max_depth": 10,
    "confidence_threshold": 0.7,
    "training_window": 1000,
    "retrain_interval": 500
  },

  "risk_management": {
    "take_profit_1": 0.05,
    "take_profit_2": 0.10,
    "stop_loss": -0.03
  },

  "kelly_fraction": 0.25,
  "initial_capital": 10000000,
  "fee_rate": 0.0005,
  "slippage": 0.0002
}
```

### 최적화 계획
- **방법**: Optuna (베이지안 최적화)
- **최적화 대상**:
  - rolling_window (20-50)
  - adaptive_rsi.adjustment_range (10-30)
  - ml_model.confidence_threshold (0.6-0.8)
  - risk_management (take_profit, stop_loss)
- **탐색 범위**: 각 파라미터별 합리적 범위 설정
- **목표 지표**: Sharpe Ratio 최대화

---

## 📈 예상 성과

### 목표 지표
```yaml
총_수익률: >= 15%  # 보수적 목표 (연구 기준 20-30% 가능)
Sharpe_Ratio: >= 1.2
Max_Drawdown: <= 25%
승률: >= 55%  # ML 검증으로 false signal 감소
Profit_Factor: >= 1.5
```

### 시장 조건별 예상 성과
- **상승장**: +20% (Adaptive threshold가 상승 추세 포착)
- **하락장**: -5% (손절로 손실 제한)
- **횡보장**: +10% (낮은 임계값으로 단기 변동 활용)

---

## 🧪 테스트 계획

### 데이터 분할
```yaml
학습: 2024-09-01 ~ 2024-11-30 (3개월)
검증: 2024-12-01 ~ 2024-12-31 (1개월)
테스트: 2025-01-01 ~ 현재
```

**이유**:
- 학습 기간 3개월 = 약 26,000개 캔들 (minute5 기준)
- RF 모델 학습에 충분한 데이터
- 최근 시장 상황 반영

### 오버피팅 방지 전략
1. **Rolling Window**: 최근 데이터만 사용 (과거 의존 X)
2. **RF 모델 정기 재학습**: 500개 캔들마다 재학습
3. **Walk-forward 분석**: 시간순 검증
4. **Cross-validation**: 시계열 분할로 검증

---

## ⚠️ 위험 요소

### 예상되는 문제점

#### 1. ML 모델 학습 시간
**현상**: 초기 1000개 캔들 동안 거래 불가
**원인**: RF 모델 학습 데이터 부족
**영향**: 백테스팅 기간 축소
**해결 방안**:
- 학습 기간 데이터로 사전 학습
- 1000개 캔들 이후부터 거래 시작

#### 2. 파라미터 복잡도
**현상**: 하이퍼파라미터 14개 → 최적화 어려움
**원인**: Adaptive + ML 시스템의 복잡성
**영향**: 오버피팅 위험
**해결 방안**:
- 핵심 파라미터 5개만 최적화
- 나머지는 문헌 기반 고정값 사용

#### 3. False Signal 위험
**현상**: ML 확률 70% 미만 시 거래 기회 상실
**원인**: 보수적 임계값
**영향**: 거래 횟수 감소
**해결 방안**:
- 백테스팅으로 최적 임계값 탐색
- v02에서 임계값 조정

---

## 📌 다음 단계

1. ✅ **계획 승인** (이 문서)
2. ⏳ **폴더 및 파일 생성**
3. ⏳ **Adaptive Threshold 구현**
4. ⏳ **Market Classifier 구현**
5. ⏳ **Random Forest 학습 파이프라인**
6. ⏳ **전략 통합 및 백테스팅**
7. ⏳ **하이퍼파라미터 최적화**
8. ⏳ **결과 분석 및 문서화**

---

## 💡 v02 발전 방향

### v01 성공 시 (목표 달성)
- **DQN/PPO 강화학습 추가**: 더 복잡한 패턴 학습
- **LSTM 가격 예측**: 단기 가격 예측 통합
- **다중 타임프레임**: minute5 + day 조합

### v01 부분 성공 시 (목표 미달)
- **앙상블 모델**: Random Forest + Gradient Boosting
- **Feature Engineering**: 더 많은 기술 지표 추가
- **하이퍼파라미터 재최적화**

### v01 실패 시 (목표 크게 미달)
- **단순화**: ML 제거, Adaptive Threshold만 사용
- **다른 지표 조합**: Bollinger Bands + Volume
- **완전히 다른 접근**: 평균회귀 전략

---

**승인자**: [사용자명]
**승인일**: 2025-10-16
**상태**: 승인 대기 중
